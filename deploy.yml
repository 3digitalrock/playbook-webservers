---
- hosts: tag_Type_{{ type_name }}
  serial: 1
  max_fail_percentage: 49
  gather_facts: false
  sudo: yes
  
  tasks:
    - name: Pull sources from the repository.
      sudo_user: ubuntu
      git: repo="{{ type_repo }}"
           dest="{{ type_root }}"
           version="{{ branch }}"
           accept_hostkey=yes
           key_file=/home/ubuntu/.ssh/github
           force=yes
        
    - name: NPM install
      sudo_user: ubuntu
      npm: path="{{ type_root }}"
        
    - name: Create the server config directory
      sudo_user: ubuntu
      file: group=ubuntu owner=ubuntu mode=755 state=directory path="{{ type_root }}/config"
        
    - name: Upload server configuration.
      copy: src=/var/lib/awx/configs/{{ type_name }}.env dest={{ type_root }}/config/.env group=ubuntu owner=ubuntu
      
    - name: Restart application server
      supervisorctl: name={{ type_name }} state=restarted
      
    - name: Delete Nginx cache
      file: path=/var/cache/nginx state=absent
      
    - name: Recreate Nginx cache
      file: group=www-data owner=www-data mode=755 state=directory path=/var/cache/nginx
